# 参加記

リアルタイムで書いている。

## 問題を読んだ

- インタラクティブ！！！
- パスの長さしか教えてくれないので、長短長短と中中中中が同一視されたりして悲しい
- 得点は、あとのクエリほど重視されるように、指数的に重み付けされた平均
  - 満点は $10^9$
  - 最後の $100$ 回がスコアの $21\%$ を占める
  - 最後の $283$ 回がスコアの $50\%$ を占める
  - 最後の $500$ 回がスコアの $73\%$ を占める
  - 最後の $664$ 回がスコアの $85\%$ を占める
  - 最後の $861$ 回がスコアの $95\%$ を占める
  - 最後の $969$ 回がスコアの $99\%$ を占める
- 入力生成が大事そう

## 入力生成まとめ

厳密には問題文にあるので、お気持ち

- $D$ によって、辺の長さの散らばり具合が決まる
- $M$ は $1$ か $2$
- 辺の長さは $1000$ 以上 $9000$ 以下、平均 $5000$
- ある**街道**の中では、辺の長さはたかだか $2D\in[200,4000]$ しか違わない
- **街道**のつくられかたは $M$ によって異なる
  - $M=1$ のとき、軸に平行な $30$ 頂点の道が街道である
  - $M=2$ のとき、軸に平行な $30$ 頂点の道がそれぞれ $2$ つに割られて街道になる
    - それぞれの街道は少なくとも $2$ つの頂点を含む
- 始点と終点のマンハッタン距離は $10$ 以上

## 環境整備

- インタラクティブどうしようかなぁ
- `trait Judge` をつくる
  - クエリを聞くことと、答えを伝えるとその長さ（に $e$ をかけたもの）を返すことができる
- `StdioJudge` と `TestJudge` をつくる
  - `StdioJudge` は提出時に使うもので、標準入出力でクエリを処理する
  - `TestJudge` はテストケース生成器がつくった入力を読んでつくれて、スコア計算などができる


## 正の点数をとる

- 上下にまっすぐ動いて、そのあと左右にまっすぐ動く
- 628830731 (average, seeds = 0..1000)

## 考察1

- 常に $M=2$ とすることは可能
  - 具体的には、$H_{i,0}=H_{i,1}, V_{i,0}=V_{i,1}$ のとき
  - 全体的に同じっぽかったら全部いっしょと見なす？
- 最短路は、すべての辺の長さが $1$ である場合の最短路であることが多い
- とくに序盤、通ったことのない辺を通ることにボーナスを設ける？
- ひとまず全ての辺の長さを $5000$ と仮定してから調査
- パス上の辺の長さの比を既知の情報で決める？
  - 既知の情報が少ないときには等分に寄せる？

## 作戦1

- $M=2, x_i=y_i=15$ と仮定する
  - 各辺 $h_{i,j}, v_{i,j}$ は街道 $H_{i,J}, V_{j,I}$ に属することになるが、$J=\lfloor j/15\rfloor, I=\lfloor i/15\rfloor$ である
- 各辺 $e$ の長さの推定値 $l_e(e)$ を、辺の長さのサンプルの平均 $\bar l(e)$ と、街道 $E$ に属する辺の長さのサンプルの平均 $\bar L(E)$ の加重平均として定める。
  - $l_e(e) = (\bar l(e) + R\bar L(E))/(1+R)$ となるが、$R=0.5$ ぐらい？
  - サンプルがないときは $5000$
- 推定値の長さを設定したグラフ上で Dijkstra 法を用いる
  - 実際には $(1+C)l_e(e)$ を設定すればいい
- パス上の辺の長さの比は推定値の比として推定し、各辺にサンプルを追加
- 街道にも同様に追加
- $R=2$ ぐらいが良さそうだった
- 919861647 (average, seeds = 0..1000)
- サンプルがないときの推定値を $4000$ に変更することで微増
  - 932416698 (average, seeds = 0..1000)

## 考察2

- $M$ の固定は頭が良さそう
  - 中終盤で $M=1$ だとわかってきたら利用したいが、後回し
- $x_i,y_i$ の固定は頭が悪そう
  - $h_i:j\mapsto h_{i,j}$ とかを $a+bU(j-c)$ で近似するのが賢そう
  - ここで $U$ は単位ステップ関数
  - 最小二乗法による近似？
  - 一般的な手法は何もわからないが、$x_i, y_i$ の全探索によって ad-hoc に解決できそう
- 古い情報は雑な辺の長さの比で推定しているから、指数的に重み付けして軽視しても良さそう
  - クエリごとに値が指数的に大きくなる重みを持っておく
- パラメータが増えるとガチャができるので楽しそうだなぁ
  - これはこれまでの TL を見た感想だが、たぶん増えないほうが嬉しい
  - が、うまい手法にはパラメータがつきもの、という感じもする

## 作戦2

- $h_i:j\mapsto h_{i,j}, v_j:i\mapsto v_{i,j}$ をそれぞれ $f:x\mapsto a(1-U(x-m))+bU(x-m)$ で近似することを考える。$U$ は単位ステップ関数。以降 $h_i$ のことだけ考える
- 明らかに $a = \mathrm{avg}_{j=0}^{m-1}h^e_{i,j}, b = \mathrm{avg}_{j=m}^{28}h^e_{i,j}$ とすればいい。ただし、$h^e_{i,j} = l_e(h_{i,j})$
- 要するに $\{h_{i,j}\}_{j=0,\ldots,m-1}$ と $\{h_{i,j}\}_{j=m,\ldots,28}$ の分散の和を最小化したい。
- $m$ を全探索するとき、変量 $x$ の分散が $\bar{x^2} - {\bar x}^2$であることを用いて、累積和で高速に処理できる
  - 高速に処理しなくてもよかったりする？まぁ、複雑にならないし良いでしょ（直感的には、高速に処理する必要がありそう）
- $D=0$ ということにしておく
- パスとその長さのデータは、それまでのクエリから得られた推定値をもとに毎クエリで全て読み直す
  - 辺の比を決め打ちして読んでいたが、それが更新されるということ
- 954312706 (average, seeds = 0..1000)